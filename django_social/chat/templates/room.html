<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Chat Room</title>
  </head>
  <body>
    <div class="chat-wrapper">
      <div id="profile-header"></div>
      <div id="chat-container"></div>

      <div class="sending-message">
        <input
          id="chat-message-input"
          type="text"
          size="100"
          placeholder="Type your message ..."
        /><br />
      </div>
      <input id="chat-message-submit" type="button" value="Send" />
    </div>
    {{ room_name|json_script:"room-name" }}
    <span></span>
    {{request.user.username|json_script:"user-name" }}
    <script>
      const roomName = JSON.parse(
        document.getElementById("room-name").textContent
      );
      const Username = JSON.parse(
        document.getElementById("user-name").textContent
      );

      const chatSocket = new WebSocket(
        "ws://" + window.location.host + "/ws/chat/" + roomName + "/"
      );

      chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);

        if (data.messages) {
          const chat = document.getElementById("chat-container");
          chat.innerHTML = "";

          for (const [content, username] of Object.entries(data.messages)) {
            const source = username === Username ? "me" : "other";
            const name = username === Username ? "Me" : username;

            chat.innerHTML +=
              '<div class="message ' +
              source +
              '">' +
              "<strong>" +
              name +
              "</strong> " +
              '<span class="date">' +
              "datetime" +
              "</span><br>" +
              content +
              "</div>";
          }
        }

        // Handle new chat messages
        if (data.message && data.user) {
          const chat = document.getElementById("chat-container");
          const source = data.user === Username ? "me" : "other";
          const name = data.user === Username ? "Me" : data.user;

          chat.innerHTML +=
            '<div class="message ' +
            source +
            '">' +
            "<strong>" +
            name +
            "</strong> " +
            '<span class="date">' +
            "datetime" +
            "</span><br>" +
            data.message +
            "</div>";
        }
      };

      chatSocket.onclose = function (e) {
        console.error("Chat socket closed unexpectedly");
      };

      document.querySelector("#chat-message-input").focus();
      document.querySelector("#chat-message-input").onkeyup = function (e) {
        if (e.keyCode === 13) {
          document.querySelector("#chat-message-submit").click();
        }
      };

      document.querySelector("#chat-message-submit").onclick = function (e) {
        const messageInputDom = document.querySelector("#chat-message-input");
        const message = messageInputDom.value;
        chatSocket.send(
          JSON.stringify({
            message: message,
            username: Username,
          })
        );
        messageInputDom.value = "";
      };
    </script>
  </body>

  <style>
    .chat-wrapper {
      position: relative;
      border: 2px solid lightgray;
      width: 40rem;
      height: 30rem;
    }
    #chat-container {
      width: 100%;
      height: 100%;
      background-color: #dfecee;
    }
    #chat-message-input {
      width: 99%;
    }
    .message {
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 5px;
      height: auto;
    }

    .me {
      background-color: #9be99b;
      align-self: flex-end;
      text-align: right;
    }

    .other {
      background-color: #e2a0e5;
      align-self: flex-start;
    }

    #chat-container {
      border: 2px solid lightgray;
      overflow-y: auto;
    }

    .profile {
      width: 100%;
      height: 10%;
      background-color: rgba(113, 113, 237, 0.746);
    }
  </style>
</html>
